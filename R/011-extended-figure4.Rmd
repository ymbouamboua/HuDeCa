---
title: "HUDECA â€” Extended Data Figure 4: Cell cycle and age-related analysis"
author: "Mbouamboua Yvon <yvon.mbouamboua@inserm.fr>"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
date: '`r format(Sys.Date())`'
---

## Goal
Final figures

## Setup
```{r setup, include=TRUE, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE, comment = "")
dir.main <- "/Users/yvon.mbouamboua/projects/singlecell/000-hudeca-nose"
dir.results <- file.path(dir.main, "output", "010-figures/extended-figure4")
dir.create(dir.results, showWarnings = FALSE, recursive = TRUE)
dir.create(file.path(dir.results, "data"), showWarnings = FALSE)

# Load packages
packages <- c("Seurat", "ggplot2", "dplyr", "grid", "decoupleR",
"SingleCellExperiment", "scran", "scater", "slingshot",
"pheatmap", "ComplexHeatmap", "ComplexUpset", "patchwork")
install_and_load <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) install.packages(pkg)
  library(pkg, character.only = TRUE)
}
invisible(lapply(packages, install_and_load))

# Load helper functions
utils_dir <- "~/projects/apps/"
r_files <- list.files(utils_dir, pattern = "\\.R$", full.names = TRUE)
invisible(lapply(r_files, source))

# Load custom colors 
custom_colors <-  readRDS(file.path(dir.main, "analysis/custom-colors-nature-safe.rds"))

```


# Load data

```{r}

obj <- readRDS(file.path(dir.main, "output/002-annotation/data/FN_harmony_clean.rds"))

```


# FigS4a

```{r}

# Load Seurat's built-in cell cycle gene lists
s.genes <- Seurat::cc.genes$s.genes
g2m.genes <- Seurat::cc.genes$g2m.genes
postm.genes <- c("DCX", "TUBB3", "MAP2", "RBFOX3", "NEUROD1", "SOX9", "ELAVL4") 

# Run Cell Cycle Scoring
obj <- CellCycleScoring(object = obj, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

# Calculate PostM Score based on PostM gene expression
obj$PostM.Score <- Seurat::FetchData(obj, vars = postm.genes) %>% rowMeans()

# Define PostM threshold (75th percentile of PostM score)
threshold <- quantile(obj$PostM.Score, 0.75)  

# Identify Non-Cycling Cells (Low UMI & low cycle scores)
nc_threshold <- 1000  # Adjust as needed
obj$NonCycling <- obj$S.Score < 0.2 & obj$G2M.Score < 0.2 & obj$nFeature_RNA < nc_threshold

# Update Cell Cycle Phases
obj$Phase <- ifelse(obj$Phase == "G1" & obj$PostM.Score > threshold, "PostM", obj$Phase)
obj$Phase <- ifelse(obj$NonCycling, "Non-Cycling", obj$Phase)  # Assign Non-Cycling

# Convert to factor with correct order
obj$Phase <- factor(obj$Phase, levels = c("G1", "S", "G2M", "PostM","Non-Cycling"))

p <- cellmap(obj, group.by = "Phase", pt.size = 0.5, figplot = T, n.cells = F,
         cols = custom_colors$phase, leg.ttl = "Phases", leg.pos = "bottom")
p
savefig(fig = p, filename = file.path(dir.results, "figS4a"), width = 6, height = 5)

```



# FigS4b

```{r fig.width=3, fig.height=3}

df_cycle <- obj@meta.data %>%
  group_by(stage, Phase) %>%
  summarise(n_cells = n(), .groups = "drop") %>%
  group_by(stage) %>%
  mutate(perc = 100 * n_cells / sum(n_cells))

p <- ggplot(df_cycle, aes(x = as.factor(stage), y = perc, fill = Phase)) +
  geom_bar(stat = "identity", position = "stack", color = "black", linewidth = 0.2) +
  scale_fill_manual(values = custom_colors$phase) +
  labs(x = "",y = "Cell proportions (%)", fill = "Phases")+
  plot_theme(font.size = 10, theme = "classic", x.angle = 45, leg.pos = "none")
print(p)

savefig(fig = p, filename = file.path(dir.results, "figS4b"), width = 1.5, height = 3)

write.table(p@data, file.path(dir.results, "data/table_figS4b.tsv"), sep = "\t", row.names = T, quote = F)

```

# Cell cycle distribution per sex

```{r fig.width=2, fig.height=3}

df_cycle <- obj@meta.data %>%
  group_by(sex, Phase) %>%
  summarise(n_cells = n(), .groups = "drop") %>%
  group_by(sex) %>%
  mutate(perc = 100 * n_cells / sum(n_cells))

p <- ggplot(df_cycle, aes(x = as.factor(sex), y = perc, fill = Phase)) +
  geom_bar(stat = "identity", position = "stack", color = "black", linewidth = 0.2) +
  scale_fill_manual(values = custom_colors$phase) +
  labs(x = "",y = "Cell proportions (%)", fill = "Phases")+
  plot_theme(font.size = 10, theme = "classic", x.angle = 45, leg.pos = "none")
print(p)

savefig(fig = p, filename = file.path(dir.results, "figS4c"), width = 1, height = 3)
write.table(p@data, file.path(dir.results, "data/table_figS4c.tsv"), sep = "\t", row.names = T, quote = F)

```






## FigS4b

```{r fig.width=2, fig.height=3}

sub <- seurat_subset(obj,  group.by = "ann2",  use.harmony = T,  harmony.group = "sample", 
                     min.dist = 1, spread = 0.5, idents = c("OHBC", "CycBasal", "MV", "SUS", "GBC", "INP", "iOSN"))

p <- plot_cell_fractions(sub, x.col = "age", fill.col = "Phase",
                         legend.title = "Phase", line.size = 1, text.size = 10,
                         custom.colors = custom_colors$phase, x.title = "Age (PCW)", 
                         plot.type = "line", legend.pos = "none")
p
savefig(fig = p, filename = file.path(dir.results, "figS4d"), width = 2, height = 3)
write.table(p@data, file.path(dir.results, "data/table_figS4d.tsv"), sep = "\t", row.names = T, quote = F)

```


```{r fig.width=3, fig.height=3}


p <- plot_cell_fractions(sub, x.col = "age", fill.col = "Phase",
                         legend.title = "Phase", line.size = 1, text.size = 10,
                         custom.colors = custom_colors$phase, x.title = "Age (PCW)", 
                         plot.type = "line", legend.pos = "right")
p
savefig(fig = p, filename = file.path(dir.results, "figS4d_v2"), width = 3, height = 3)

```



```{r fig.width=7, fig.height=7}

Idents(obj) <- "ann2"
p <- cellvio(obj, features = c("TOP2A","MKI67","CENPF","S.Score","G2M.Score","PostM.Score"), 
                 stack = T, ncol = 1, group.by = "ann2", cols = custom_colors$ann2,
                 font.size = 10, x.angle = 45, ttl.pos = "left")
p
savefig(fig = p, filename = file.path(dir.results, "figS4e"), width = 7, height = 7.5)

```
## figS4f

```{r fig.width=3, fig.height=5, warning=F}

p <- plot_props(data = obj, x = "ann2", y = "Phase", plot.type = "bar", prop = T, stack = T,font.size = 10,
                coord.flip = T, prop.multi = F, theme = "classic", legend = F, colors = custom_colors$phase, 
                x.title = "", x.angle = 0, x.reverse = T, y.reverse = F)

print(p)
savefig(fig = p, filename = file.path(dir.results, "figS4f"), width = 3, height = 5)

```


# Session Info

```{r session_info}
utils::capture.output(devtools::session_info())
```







