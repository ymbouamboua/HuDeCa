---
title: "HUDECA â€” Extended Data Figure 9. Developmental activation of olfactory receptor programs in neuronal lineages"
author: "Mbouamboua Yvon <yvon.mbouamboua@inserm.fr>"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
date: '`r format(Sys.Date())`'
---

## Goal
Final figures

## Setup

```{r setup, include=TRUE, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(message = FALSE, warning = FALSE)
root <- '/Users/yvon.mbouamboua/projects/singlecell/000-hudeca'
outdir <- file.path(root, 'out', '000-github/figS9')
invisible(lapply(c(outdir, file.path(outdir, 'data'), file.path(outdir, 'plots')),
                 dir.create, recursive = TRUE, showWarnings = FALSE))
srcr <- file.path(root, 'src', 'R')
invisible(lapply(list.files(srcr, full.names = TRUE), source))
appdir <- Sys.getenv('APPS', '~/projects/apps')
if (dir.exists(appdir)) {
  pkgfile <- file.path(appdir, 'packages.R')
  if (file.exists(pkgfile)) sys.source(pkgfile, envir = .GlobalEnv)
  helper_files <- list.files(appdir, pattern = '\\.R$', full.names = TRUE)
  helper_files <- helper_files[basename(helper_files) != 'packages.R']
  invisible(lapply(helper_files, sys.source, envir = .GlobalEnv))
}

```


# Load data

```{r}

obj <- readRDS(file.path(root, "out/002-annotation/data/FN_harmony_clean.rds"))
custom_colors <-  readRDS(file.path(root, "analysis/custom-colors-nature-safe.rds"))
ORs <- readxl::read_excel(file.path(root, "data/proc/ORs/401_ORs.xlsx"))

```

# FigS9a

```{r fig.width=8, fig.height=4}

sub <- cellslice(obj,  group.by = "ann2",  use.harmony = T,  harmony.group = "sample", idents = c("INP", "iOSN"), preprocess = T)

# keep as factor with order
sub@meta.data$stage <- factor(
  sub@meta.data$stage,
  levels = c("PCW12","PCW10","PCW8","PCW7")
)
#sub@meta.data$stage <- as.character(sub@meta.data$stage)

res <- gsetplot(
  obj = sub,
  geneset = ORs$Gene_name,
  group.by = "ann2",
  stage = "stage",
  mode = "faceted",
  facet.ncol = 4,
  x.lab = "Olfactory receptors",
  panel.fill = "white",
  facet.bg = FALSE,
  ann.counts = FALSE,
  fill.cols = c("INP" = "#4463D9", "iOSN" = "#C63F70"),
  leg.pos = c(0.1, 0.95)
)

res$binned.data
res$plot
savefig(fig = res$plot, filename = file.path(outdir, "plots/figS9a"), width = 8, height = 4)
write.table(res$binned.data, file = file.path(outdir, "data/data_figS9a.tsv"), sep = "\t", row.names = F, quote = F)


```


# FigS9b

```{r fig.width=6, fig.height=7}

sub <- cellslice(obj,  group.by = "ann2", idents = c("OHBC", "CycBasal", "MV", "SUS", "GBC", "INP", "iOSN"), use.harmony = T,  harmony.group = "sample", preprocess = T)
genes <- intersect(ORs$Gene_name, rownames(sub))
res <- domscore(obj = sub, geneset = genes, group.by = "ann2", add.meta = c("sample", "stage", "sex"), idents = c("INP", "iOSN"), bins = c(-Inf, 0.5, 1, 1.5, 2, Inf))

# Top dominant genes faceted by stage
p <- plot_domscore(res$df, mode = "top_genes", stage.col = "stage", ncol = 4, top.n = 20, font.size = 10, x.angle = 0)
p
savefig(fig = p, filename = file.path(outdir, "plots/figS9b"), width = 6, height = 7)
write.table(p@data, file.path(outdir, "data/data_figS9b.tsv"), sep = "\t", row.names = F, quote = F)

```


# Session Info

```{r session_info}
utils::capture.output(devtools::session_info())
```
