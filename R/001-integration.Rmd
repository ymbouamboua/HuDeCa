---
title: "HUDECA â€” 001 INTEGRATION"
author: "Mbouamboua Yvon <yvon.mbouamboua@inserm.fr>"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
date: '`r format(Sys.Date())`'
---

## Goal
Batch correction and integration

## Setup
```{r setup, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, comment = "")
dir.main <- "/Users/yvon.mbouamboua/projects/singlecell/000-hudeca-nose"
dir.results <- file.path(dir.main, "output", "001-integration")
dir.create(dir.results, showWarnings = FALSE, recursive = TRUE)
dir.create(file.path(dir.results, "data"), showWarnings = FALSE)
dir.create(file.path(dir.results, "plots"), showWarnings = FALSE)

# Load packages
packages <- c("Seurat", "ggplot2", "dplyr", "grid",
"SingleCellExperiment", "scran", "scater",
"pheatmap", "ComplexHeatmap", "ComplexUpset", "patchwork")
install_and_load <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) install.packages(pkg)
  library(pkg, character.only = TRUE)
}
invisible(lapply(packages, install_and_load))

# Load helper functions
utils_dir <- "~/projects/apps/"
r_files <- list.files(utils_dir, pattern = "\\.R$", full.names = TRUE)
invisible(lapply(r_files, source))
```

# Load seurat processed samples

```{r}

obj <- readRDS(file.path(dir.main, "output/000-preprocessing/data/filt_merged.rds"))
invisible(gc())

```


# Harmony Integration

```{r fig.width=10, fig.height=6}

obj[["RNA"]] <- split(obj[["RNA"]], f = obj$BulkSample)
obj <- NormalizeData(obj)
obj <- FindVariableFeatures(obj)
obj <- ScaleData(obj)
obj <- RunPCA(obj, npcs = 50)
obj <- FindNeighbors(obj, dims = 1:50, reduction = "pca")
obj <- FindClusters(obj, resolution = 0.5, cluster.name = "unintegrated_clusters")

obj <- IntegrateLayers(
  object = obj, method = HarmonyIntegration,
  orig.reduction = "pca", new.reduction = "harmony",
  verbose = FALSE
)

ndims <- get_pcs(obj)
obj <- RunUMAP(obj, reduction = "pca", dims = 1:ndims, min.dist = 0.6, spread = 1)
obj <- FindNeighbors(obj, reduction = "pca", dims = 1:ndims)
obj <- FindClusters(obj, resolution = c(0.5,1.5))
obj <- JoinLayers(obj)
obj <- fix_seurat_matrix_names(obj)

obj <- subset(obj, cells = WhichCells(merged))
obj <- obj[, WhichCells(merged)]
obj <- NormalizeData(obj) %>% FindVariableFeatures() %>% ScaleData()

cellmap(object = obj, group.by = "seurat_clusters")
cellmap(object = obj, group.by = "BulkSample")
saveRDS(obj, file.path(dir.results, "data/FN_integrated.rds"))

```

# Session Info

```{r session_info}
utils::capture.output(devtools::session_info())
```
