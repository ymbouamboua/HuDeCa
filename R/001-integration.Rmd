---
title: "000-HUDECA â€” 001-integration"
output: html_document
date: '`r Sys.Date()`'
---

## Goal
Batch correction & integration

## Setup
```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
root <- '/Users/yvon.mbouamboua/projects/singlecell/000-hudeca'
outdir <- file.path(root, 'out', '0001-integrattion')
invisible(lapply(c(outdir, file.path(outdir, 'data'), file.path(outdir, 'plots')),
                 dir.create, recursive = TRUE, showWarnings = FALSE))
srcr <- file.path(root, 'src', 'R')
invisible(lapply(list.files(srcr, full.names = TRUE), source))
appdir <- Sys.getenv('APPS', '~/projects/apps')
if (dir.exists(appdir)) {
  pkgfile <- file.path(appdir, 'packages.R')
  if (file.exists(pkgfile)) sys.source(pkgfile, envir = .GlobalEnv)
  helper_files <- list.files(appdir, pattern = '\\.R$', full.names = TRUE)
  helper_files <- helper_files[basename(helper_files) != 'packages.R']
  invisible(lapply(helper_files, sys.source, envir = .GlobalEnv))
}

```

# Load seurat processed samples

```{r}

obj <- readRDS(file.path(dir.main, "out/000-qc/data/merged.rds"))
invisible(gc())

```


# Harmony Integration

```{r fig.width=10, fig.height=6}

obj[["RNA"]] <- split(obj[["RNA"]], f = obj$BulkSample)
obj <- NormalizeData(obj)
obj <- FindVariableFeatures(obj)
obj <- ScaleData(obj)
obj <- RunPCA(obj, npcs = 50)
obj <- FindNeighbors(obj, dims = 1:50, reduction = "pca")
obj <- FindClusters(obj, resolution = 0.5, cluster.name = "unintegrated_clusters")

obj <- IntegrateLayers(
  object = obj, method = HarmonyIntegration,
  orig.reduction = "pca", new.reduction = "harmony",
  verbose = FALSE
)

ndims <- get_pcs(obj)
obj <- RunUMAP(obj, reduction = "pca", dims = 1:ndims, min.dist = 0.6, spread = 1)
obj <- FindNeighbors(obj, reduction = "pca", dims = 1:ndims)
obj <- FindClusters(obj, resolution = c(0.5,1.5))
obj <- JoinLayers(obj)
obj <- fix_seurat_matrix_names(obj)

obj <- subset(obj, cells = WhichCells(merged))
obj <- obj[, WhichCells(merged)]
obj <- NormalizeData(obj) %>% FindVariableFeatures() %>% ScaleData()


cellmap(object = obj, group.by = "seurat_clusters")
cellmap(object = obj, group.by = "BulkSample")
saveRDS(obj, file.path(dir.results, "data/FN_integrated.rds"))

```

```{r fig.width=10, fig.height=5}
cellvio(obj, group.by = "seurat_clusters", features = c("nFeature_RNA", "nCount_RNA","percent_mito"), stack = T, pt.size = 0.1)
```


```{r}

table(merged@meta.data$BulkSample)

df1 <- raw@meta.data %>%
  group_by(BulkSample) %>%
  summarise(n_cells = n()) %>%
  mutate(stage = "raw")


df2 <- merged@meta.data %>%
  group_by(BulkSample) %>%
  summarise(n_cells = n()) %>%
  mutate(stage = "pre-integration")

# Combine
df <- bind_rows(df1,df2)

```


```{r fig.width=5, fig.height=6}

violin_plot(obj, group.by = "BulkSample", set.assay = "RNA", set.slot = "data", features = c("nCount_RNA", "nFeature_RNA", "percent_mito"), stacked = T, ncol = 1, pt.size = 0.1)
violin_plot(obj, group.by = "BulkSample", set.assay = "RNA", set.slot = "data", features = c("XIST","UTY","USP9Y"), stacked = T, ncol = 1, pt.size = 0)

```


## Session info
```{r}
sessionInfo()
```
